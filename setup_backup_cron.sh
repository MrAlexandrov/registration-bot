#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ cron
# –°–æ–∑–¥–∞—ë—Ç –∑–∞–¥–∞—á—É cron –¥–ª—è –∑–∞–ø—É—Å–∫–∞ dump.sh –∫–∞–∂–¥—ã–π —á–∞—Å

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "================================================"
echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "================================================"
echo ""

# –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DUMP_SCRIPT="$SCRIPT_DIR/dump.sh"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ dump.sh
if [ ! -f "$DUMP_SCRIPT" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª dump.sh –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: $DUMP_SCRIPT${NC}"
    exit 1
fi

# –î–µ–ª–∞–µ–º dump.sh –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x "$DUMP_SCRIPT"
echo -e "${GREEN}‚úÖ –§–∞–π–ª dump.sh —Å–¥–µ–ª–∞–Ω –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º${NC}"

# –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
LOG_DIR="$SCRIPT_DIR/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/backup.log"

echo -e "${GREEN}‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∞: $LOG_DIR${NC}"

# –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É cron (–∫–∞–∂–¥—ã–π —á–∞—Å)
CRON_JOB="0 * * * * $DUMP_SCRIPT >> $LOG_FILE 2>&1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–¥–∞—á–∞
if crontab -l 2>/dev/null | grep -q "$DUMP_SCRIPT"; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ó–∞–¥–∞—á–∞ cron –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç${NC}"
    echo ""
    echo "–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ cron:"
    crontab -l | grep "$DUMP_SCRIPT"
    echo ""
    read -p "–•–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        exit 0
    fi
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É
    crontab -l | grep -v "$DUMP_SCRIPT" | crontab -
    echo -e "${GREEN}‚úÖ –°—Ç–∞—Ä–∞—è –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞${NC}"
fi

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É cron
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}‚úÖ –ó–∞–¥–∞—á–∞ cron —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!${NC}"
    echo ""
    echo "üìã –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏:"
    echo "   –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –ö–∞–∂–¥—ã–π —á–∞—Å (–≤ –Ω–∞—á–∞–ª–µ —á–∞—Å–∞)"
    echo "   –°–∫—Ä–∏–ø—Ç: $DUMP_SCRIPT"
    echo "   –õ–æ–≥: $LOG_FILE"
    echo ""
    echo "üìä –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ cron:"
    crontab -l | grep "$DUMP_SCRIPT"
    echo ""
    echo -e "${YELLOW}üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
    echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ cron:  crontab -l"
    echo "   –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ cron:    crontab -e"
    echo "   –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ cron:      crontab -r"
    echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:             tail -f $LOG_FILE"
    echo ""
    echo -e "${GREEN}‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
    echo ""
    echo "–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:"
    echo "$SCRIPT_DIR/dumps"
    echo ""
    echo "–°—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π) –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å—Å—è."
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ cron${NC}"
    exit 1
fi